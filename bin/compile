#!/bin/bash
# Usage: bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

# START CONFIG
NGINX_VERSION=1.3.11
PHP_VERSION=5.4.11
WORDPRESS_VERSION=3.5.1
S3_BUCKET=heroku-buildpack-wordpress
# END CONFIG

#
NGINX_URL="https://s3.amazonaws.com/${S3_BUCKET}/nginx-${NGINX_VERSION}-heroku.tar.gz"
PHP_URL="https://s3.amazonaws.com/${S3_BUCKET}/php-${PHP_VERSION}-with-fpm-heroku.tar.gz"
WORDPRESS_URL="http://wordpress.org/wordpress-${WORDPRESS_VERSION}.tar.gz"
#

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

BUILD_DIR=$1
CACHE_DIR=$2
mkdir -p $BUILD_DIR $CACHE_DIR

# Nginx
cd ${BUILD_DIR}
echo "-----> Installing Nginx v${NGINX_VERSION}"
if [ ! -d ./runtimes/nginx ]; then
  mkdir -p ./runtimes/nginx && cd ./runtimes/nginx
  curl --silent --max-time 60 --location $NGINX_URL | tar xz
fi

# Wordpress
cd ${BUILD_DIR}
echo "-----> Installing Wordpress v${WORDPRESS_VERSION}"
if [ ! -d ./runtimes/nginx ]; then
  mkdir -p ./public/wp && cd ./public/wp
  curl --silent --max-time 60 --location $WORDPRESS_URL | tar xz
fi

echo "-----> Creating bin/ scripts"
mkdir -p ${BUILD_DIR}/bin
cd ${BUILD_DIR}

# Setup
echo "Writing setup.sh script" | indent
cat >bin/setup.sh <<EOF
#!/usr/bin/env bash

erb config/nginx/wordpress.conf.erb > config/nginx/wordpress.conf
chmod 755 public/wp-content

# Expose Heroku config vars to PHP-FPM processes
#for var in \`env | cut -f1 -d=\`; do
#  echo "env[\$var] = \\$\${var}" >> /app/vendor/php/etc/php-fpm.conf
#done

mkdir -p run/nginx_cache

mkdir -p logs
touch logs/access.log logs/error.log logs/php-fpm.log
EOF
chmod +x bin/setup.sh

# Cron job
echo "Writing cron.sh script" | indent
cat >bin/cron.sh <<EOF
#!/usr/bin/env bash

setup.sh && cd public && php wp-cron.php
EOF
chmod +x bin/cron.sh

# Startup
echo "Writing start.sh script" | indent
cat >bin/start.sh <<EOF
#!/usr/bin/env bash

echo "Starting nginx and hiphop"
bin/setup.sh
(tail -qF -n 0 logs/*.log &)
#php-fpm
#runtimes/nginx/sbin/nginx -c config/nginx/nginx.conf
nginx -c `pwd`/config/nginx/nginx.conf 
EOF
chmod +x bin/start.sh

echo "-----> Done with compile"
